# M4 里程碑目标（阶段 4）

依据 `docs/QRGen.md` 第 10 节里程碑建议，M4 的目标为：

## M4：规划并实现第一个扩展特性（多格式导出）

### 目标
- 在不破坏现有默认行为（Terminal TUI）与 `-o` 文件输出能力的前提下，引入统一的 `--format` 参数。
- 支持以下导出格式：`avif`、`png`、`jpeg`、`webp`。
- 让输出格式能力可扩展，便于后续新增格式或做编码参数细化。

### 范围（In Scope）
- 新增参数：`--format <FORMAT>`。
- `--format` 可选值固定为：`avif|png|jpeg|webp`。
- 当指定 `-o/--output` 时按 `--format` 导出对应格式文件。
- 参数约束：
  - 未指定 `-o` 时不允许仅传 `--format`（需报错并提示）。
  - `--format` 传入非法值时给出清晰错误信息与可选值列表。
- 保持现有兼容行为：
  - 不指定 `-o` 时仍为 Terminal TUI。
  - 指定 `-o` 且未显式传 `--format` 时，默认 `png`。
- 帮助信息与 README 增加多格式示例。

### 非范围（Out of Scope）
- 色彩/压缩级别/质量参数细化（如 `--quality`、`--lossless`）。
- 颜色定制（前景/背景）。
- 纠错级别可配置（L/M/Q/H）。
- Logo 嵌入、批量输入等高级能力。

### 具体达成要点
**功能实现（必需）**
- `--format` 参数解析与枚举校验完成。
- 导出路径按格式分发到对应编码实现。
- 错误信息符合“原因 + 建议动作”规范。

**文档与可用性（必需）**
- `--help` 中列出全部支持格式与默认行为。
- README 至少提供 3 条多格式示例命令（如 `webp`、`avif`、`jpeg`）。

**测试（必需）**
- 成功路径测试：覆盖 `png` 与至少 2 种新增格式导出成功。
- 失败路径测试：
  - `--format` 非法值。
  - 仅传 `--format` 未传 `-o`。
- 回归测试：默认 TUI 与 `-o` 默认 `png` 仍按预期工作。

### 验收标准（M4 DoD）
1. `qrgen "https://example.com" -o ./dist/a.png --format png` 可生成 PNG。
2. `qrgen "https://example.com" -o ./dist/a.webp --format webp` 可生成 WebP。
3. `qrgen "https://example.com" -o ./dist/a.avif --format avif` 可生成 AVIF。
4. `--format` 支持值明确为：`avif/png/jpeg/webp`，非法值返回非 0 且有清晰提示。
5. `qrgen "https://example.com"` 仍走 Terminal TUI；`-o` 未传 `--format` 时默认 `png`。
6. `--help` 与 README 包含多格式导出说明和示例。

### 下一步目标（M5 候选）
- 增加 `jxl`、`heif` 的可选支持（按 feature flag 或系统编码器能力启用）。
- 新增编码参数：`--quality` 与有损/无损模式控制。
- 增加输出格式能力探测命令（如 `qrgen --list-formats`），明确当前构建可用格式。
